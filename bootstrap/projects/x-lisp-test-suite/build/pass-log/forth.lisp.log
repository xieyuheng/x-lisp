;;; Input

(define (swap f x y) (f y x))

(define (drop f) (lambda (dropped) (lambda (x) (f x))))

(define (dup f) (lambda (x) (f x x)))

(define (identity x) x)

(define (main)
  (println-non-void
   (begin (= f identity) (= g (dup identity)) (g f f))))

;;; ShrinkPass

(define (swap f x y) ((f y) x))

(define (drop f) (lambda (dropped) (lambda (x) (f x))))

(define (dup f) (lambda (x) ((f x) x)))

(define (identity x) x)

(define (main)
  (println-non-void
   (@let1 f identity (@let1 g (dup identity) ((g f) f)))))

;;; UniquifyPass

(define (swap f x y) ((f y) x))

(define (drop f) (lambda (dropped₁) (lambda (x₁) (f x₁))))

(define (dup f) (lambda (x₁) ((f x₁) x₁)))

(define (identity x) x)

(define (main)
  (println-non-void
   (@let1 f₁ identity
     (@let1 g₁ (dup identity) ((g₁ f₁) f₁)))))

;;; RevealFunctionPass

(define (swap f x y) ((f y) x))

(define (drop f) (lambda (dropped₁) (lambda (x₁) (f x₁))))

(define (dup f) (lambda (x₁) ((f x₁) x₁)))

(define (identity x) x)

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 f₁ (@primitive-function identity 1)
     (@let1 g₁
         ((@function dup 1) (@primitive-function identity 1))
       ((g₁ f₁) f₁)))))

;;; LiftLambdaPass

(define (swap f x y) ((f y) x))

(define (drop f)
  ((((@primitive-function curry-put! 3) 0) f)
   ((((@primitive-function make-curry 3)
      (@function drop/λ₁ 2))
     2)
    1)))

(define (drop/λ₁ f dropped₁)
  ((((@primitive-function curry-put! 3) 0) f)
   ((((@primitive-function make-curry 3)
      (@function drop/λ₁/λ₁ 2))
     2)
    1)))

(define (drop/λ₁/λ₁ f x₁) (f x₁))

(define (dup f)
  ((((@primitive-function curry-put! 3) 0) f)
   ((((@primitive-function make-curry 3)
      (@function dup/λ₁ 2))
     2)
    1)))

(define (dup/λ₁ f x₁) ((f x₁) x₁))

(define (identity x) x)

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 f₁ (@primitive-function identity 1)
     (@let1 g₁
         ((@function dup 1) (@primitive-function identity 1))
       ((g₁ f₁) f₁)))))

;;; UnnestOperandPass

(define (swap f x y) (@let1 _₁ (f y) (_₁ x)))

(define (drop f)
  (@let1 _₁ (@primitive-function curry-put! 3)
    (@let1 _₂ 0
      (@let1 _₃ (_₁ _₂)
        (@let1 _₄ (_₃ f)
          (@let1 _₅ (@primitive-function make-curry 3)
            (@let1 _₆ (@function drop/λ₁ 2)
              (@let1 _₇ (_₅ _₆)
                (@let1 _₈ 2
                  (@let1 _₉ (_₇ _₈)
                    (@let1 _₁₀ 1
                      (@let1 _₁₁ (_₉ _₁₀) (_₄ _₁₁)))))))))))))

(define (drop/λ₁ f dropped₁)
  (@let1 _₁ (@primitive-function curry-put! 3)
    (@let1 _₂ 0
      (@let1 _₃ (_₁ _₂)
        (@let1 _₄ (_₃ f)
          (@let1 _₅ (@primitive-function make-curry 3)
            (@let1 _₆ (@function drop/λ₁/λ₁ 2)
              (@let1 _₇ (_₅ _₆)
                (@let1 _₈ 2
                  (@let1 _₉ (_₇ _₈)
                    (@let1 _₁₀ 1
                      (@let1 _₁₁ (_₉ _₁₀) (_₄ _₁₁)))))))))))))

(define (drop/λ₁/λ₁ f x₁) (f x₁))

(define (dup f)
  (@let1 _₁ (@primitive-function curry-put! 3)
    (@let1 _₂ 0
      (@let1 _₃ (_₁ _₂)
        (@let1 _₄ (_₃ f)
          (@let1 _₅ (@primitive-function make-curry 3)
            (@let1 _₆ (@function dup/λ₁ 2)
              (@let1 _₇ (_₅ _₆)
                (@let1 _₈ 2
                  (@let1 _₉ (_₇ _₈)
                    (@let1 _₁₀ 1
                      (@let1 _₁₁ (_₉ _₁₀) (_₄ _₁₁)))))))))))))

(define (dup/λ₁ f x₁) (@let1 _₁ (f x₁) (_₁ x₁)))

(define (identity x) x)

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 f₁ (@primitive-function identity 1)
      (@let1 g₁
          (@let1 _₂ (@function dup 1)
            (@let1 _₃ (@primitive-function identity 1)
              (_₂ _₃)))
        (@let1 _₄ (g₁ f₁) (@let1 _₅ (_₄ f₁) (_₁ _₅)))))))

;;; ExplicateControlPass

(define-function identity
  (block entry (= x (argument 0)) (return x)))

(define-function swap
  (block entry
    (= f (argument 0))
    (= x (argument 1))
    (= y (argument 2))
    (= _₁ (apply f y))
    (= _↩ (apply _₁ x))
    (return _↩)))

(define-function drop
  (block entry
    (= f (argument 0))
    (= _₁ (const (@primitive-function curry-put! 3)))
    (= _₂ (const 0))
    (= _₃ (apply _₁ _₂))
    (= _₄ (apply _₃ f))
    (= _₅ (const (@primitive-function make-curry 3)))
    (= _₆ (const (@function drop/λ₁ 2)))
    (= _₇ (apply _₅ _₆))
    (= _₈ (const 2))
    (= _₉ (apply _₇ _₈))
    (= _₁₀ (const 1))
    (= _₁₁ (apply _₉ _₁₀))
    (= _↩ (apply _₄ _₁₁))
    (return _↩)))

(define-function drop/λ₁
  (block entry
    (= f (argument 0))
    (= dropped₁ (argument 1))
    (= _₁ (const (@primitive-function curry-put! 3)))
    (= _₂ (const 0))
    (= _₃ (apply _₁ _₂))
    (= _₄ (apply _₃ f))
    (= _₅ (const (@primitive-function make-curry 3)))
    (= _₆ (const (@function drop/λ₁/λ₁ 2)))
    (= _₇ (apply _₅ _₆))
    (= _₈ (const 2))
    (= _₉ (apply _₇ _₈))
    (= _₁₀ (const 1))
    (= _₁₁ (apply _₉ _₁₀))
    (= _↩ (apply _₄ _₁₁))
    (return _↩)))

(define-function drop/λ₁/λ₁
  (block entry
    (= f (argument 0))
    (= x₁ (argument 1))
    (= _↩ (apply f x₁))
    (return _↩)))

(define-function dup
  (block entry
    (= f (argument 0))
    (= _₁ (const (@primitive-function curry-put! 3)))
    (= _₂ (const 0))
    (= _₃ (apply _₁ _₂))
    (= _₄ (apply _₃ f))
    (= _₅ (const (@primitive-function make-curry 3)))
    (= _₆ (const (@function dup/λ₁ 2)))
    (= _₇ (apply _₅ _₆))
    (= _₈ (const 2))
    (= _₉ (apply _₇ _₈))
    (= _₁₀ (const 1))
    (= _₁₁ (apply _₉ _₁₀))
    (= _↩ (apply _₄ _₁₁))
    (return _↩)))

(define-function dup/λ₁
  (block entry
    (= f (argument 0))
    (= x₁ (argument 1))
    (= _₁ (apply f x₁))
    (= _↩ (apply _₁ x₁))
    (return _↩)))

(define-function main
  (block entry
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= f₁ (const (@primitive-function identity 1)))
    (= _₂ (const (@function dup 1)))
    (= _₃ (const (@primitive-function identity 1)))
    (= g₁ (apply _₂ _₃))
    (= _₄ (apply g₁ f₁))
    (= _₅ (apply _₄ f₁))
    (= _↩ (apply _₁ _₅))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code identity
  (block entry
    (movq (reg rdi) (var x))
    (movq (var x) (reg rax))
    (retq)))

(define-code swap
  (block entry
    (movq (reg rdi) (var f))
    (movq (reg rsi) (var x))
    (movq (reg rdx) (var y))
    (movq (var f) (reg rdi))
    (movq (var y) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁))
    (movq (var _₁) (reg rdi))
    (movq (var x) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code drop
  (block entry
    (movq (reg rdi) (var f))
    (leaq
     (label-deref (external-label x-curry-put!))
     (var _₁))
    (movq (imm 0) (var _₂))
    (movq (var _₁) (reg rdi))
    (movq (var _₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (movq (var f) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (leaq
     (label-deref (external-label x-make-curry))
     (var _₅))
    (leaq (label-deref (label drop/λ₁)) (var _₆))
    (movq (var _₅) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (imm 2) (var _₈))
    (movq (var _₇) (reg rdi))
    (movq (var _₈) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (movq (imm 1) (var _₁₀))
    (movq (var _₉) (reg rdi))
    (movq (var _₁₀) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₁))
    (movq (var _₄) (reg rdi))
    (movq (var _₁₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code drop/λ₁
  (block entry
    (movq (reg rdi) (var f))
    (movq (reg rsi) (var dropped₁))
    (leaq
     (label-deref (external-label x-curry-put!))
     (var _₁))
    (movq (imm 0) (var _₂))
    (movq (var _₁) (reg rdi))
    (movq (var _₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (movq (var f) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (leaq
     (label-deref (external-label x-make-curry))
     (var _₅))
    (leaq (label-deref (label drop/λ₁/λ₁)) (var _₆))
    (movq (var _₅) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (imm 2) (var _₈))
    (movq (var _₇) (reg rdi))
    (movq (var _₈) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (movq (imm 1) (var _₁₀))
    (movq (var _₉) (reg rdi))
    (movq (var _₁₀) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₁))
    (movq (var _₄) (reg rdi))
    (movq (var _₁₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code drop/λ₁/λ₁
  (block entry
    (movq (reg rdi) (var f))
    (movq (reg rsi) (var x₁))
    (movq (var f) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code dup
  (block entry
    (movq (reg rdi) (var f))
    (leaq
     (label-deref (external-label x-curry-put!))
     (var _₁))
    (movq (imm 0) (var _₂))
    (movq (var _₁) (reg rdi))
    (movq (var _₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (movq (var f) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (leaq
     (label-deref (external-label x-make-curry))
     (var _₅))
    (leaq (label-deref (label dup/λ₁)) (var _₆))
    (movq (var _₅) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (imm 2) (var _₈))
    (movq (var _₇) (reg rdi))
    (movq (var _₈) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (movq (imm 1) (var _₁₀))
    (movq (var _₉) (reg rdi))
    (movq (var _₁₀) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₁))
    (movq (var _₄) (reg rdi))
    (movq (var _₁₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code dup/λ₁
  (block entry
    (movq (reg rdi) (var f))
    (movq (reg rsi) (var x₁))
    (movq (var f) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁))
    (movq (var _₁) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code main
  (block entry
    (leaq
     (label-deref (external-label x-println-non-void))
     (var _₁))
    (leaq (label-deref (external-label x-identity)) (var f₁))
    (leaq (label-deref (label dup)) (var _₂))
    (leaq (label-deref (external-label x-identity)) (var _₃))
    (movq (var _₂) (reg rdi))
    (movq (var _₃) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var g₁))
    (movq (var g₁) (reg rdi))
    (movq (var f₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (movq (var _₄) (reg rdi))
    (movq (var f₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (var _₁) (reg rdi))
    (movq (var _₅) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

