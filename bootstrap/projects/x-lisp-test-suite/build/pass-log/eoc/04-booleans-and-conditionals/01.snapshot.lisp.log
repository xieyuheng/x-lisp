;;; Input

(define (main)
  (println-non-void
   (begin
     (= x (random-dice))
     (= y (random-dice))
     (if (if (int-less? x 1) (equal? x 0) (equal? x 2))
       (iadd y 2)
       (iadd y 10)))))

;;; ShrinkPass

(define (main)
  (println-non-void
   (@let1 x (random-dice)
     (@let1 y (random-dice)
       (if
           (if ((int-less? x) 1)
             ((equal? x) 0)
             ((equal? x) 2))
         ((iadd y) 2)
         ((iadd y) 10))))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 x₁ (random-dice)
     (@let1 y₁ (random-dice)
       (if
           (if ((int-less? x₁) 1)
             ((equal? x₁) 0)
             ((equal? x₁) 2))
         ((iadd y₁) 2)
         ((iadd y₁) 10))))))

;;; RevealFunctionPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ ((@primitive-function random-dice 0))
     (@let1 y₁ ((@primitive-function random-dice 0))
       (if
           (if (((@primitive-function int-less? 2) x₁) 1)
             (((@primitive-function equal? 2) x₁) 0)
             (((@primitive-function equal? 2) x₁) 2))
         (((@primitive-function iadd 2) y₁) 2)
         (((@primitive-function iadd 2) y₁) 10))))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ ((@primitive-function random-dice 0))
     (@let1 y₁ ((@primitive-function random-dice 0))
       (if
           (if (((@primitive-function int-less? 2) x₁) 1)
             (((@primitive-function equal? 2) x₁) 0)
             (((@primitive-function equal? 2) x₁) 2))
         (((@primitive-function iadd 2) y₁) 2)
         (((@primitive-function iadd 2) y₁) 10))))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 x₁
        (@let1 _₂ (@primitive-function random-dice 0) (_₂))
      (@let1 y₁
          (@let1 _₃ (@primitive-function random-dice 0)
            (_₃))
        (@let1 _₄
            (@let1 _₅
                (@let1 _₆ (@primitive-function int-less? 2)
                  (@let1 _₇ (_₆ x₁)
                    (@let1 _₈ 1
                      (@let1 _₉ (_₇ _₈)
                        (if _₉
                          (@let1 _₁₀
                              (@primitive-function equal? 2)
                            (@let1 _₁₁ (_₁₀ x₁)
                              (@let1 _₁₂ 0 (_₁₁ _₁₂))))
                          (@let1 _₁₃
                              (@primitive-function equal? 2)
                            (@let1 _₁₄ (_₁₃ x₁)
                              (@let1 _₁₅ 2 (_₁₄ _₁₅)))))))))
              (if _₅
                (@let1 _₁₆ (@primitive-function iadd 2)
                  (@let1 _₁₇ (_₁₆ y₁)
                    (@let1 _₁₈ 2 (_₁₇ _₁₈))))
                (@let1 _₁₉ (@primitive-function iadd 2)
                  (@let1 _₂₀ (_₁₉ y₁)
                    (@let1 _₂₁ 10 (_₂₀ _₂₁))))))
          (_₁ _₄))))))

;;; ExplicateControlPass

(define-function main
  (block entry
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const (@primitive-function random-dice 0)))
    (= x₁ (nullary-apply _₂))
    (= _₃ (const (@primitive-function random-dice 0)))
    (= y₁ (nullary-apply _₃))
    (= _₆ (const (@primitive-function int-less? 2)))
    (= _₇ (apply _₆ x₁))
    (= _₈ (const 1))
    (= _₉ (apply _₇ _₈))
    (branch _₉ main/then₅ main/else₆))
  (block main/let-body₁ (= _↩ (apply _₁ _₄)) (return _↩))
  (block main/then₂
    (= _₁₆ (const (@primitive-function iadd 2)))
    (= _₁₇ (apply _₁₆ y₁))
    (= _₁₈ (const 2))
    (= _₄ (apply _₁₇ _₁₈))
    (goto main/let-body₁))
  (block main/else₃
    (= _₁₉ (const (@primitive-function iadd 2)))
    (= _₂₀ (apply _₁₉ y₁))
    (= _₂₁ (const 10))
    (= _₄ (apply _₂₀ _₂₁))
    (goto main/let-body₁))
  (block main/let-body₄ (branch _₅ main/then₂ main/else₃))
  (block main/then₅
    (= _₁₀ (const (@primitive-function equal? 2)))
    (= _₁₁ (apply _₁₀ x₁))
    (= _₁₂ (const 0))
    (= _₅ (apply _₁₁ _₁₂))
    (goto main/let-body₄))
  (block main/else₆
    (= _₁₃ (const (@primitive-function equal? 2)))
    (= _₁₄ (apply _₁₃ x₁))
    (= _₁₅ (const 2))
    (= _₅ (apply _₁₄ _₁₅))
    (goto main/let-body₄)))

;;; SelectInstructionPass

(export)

(define-code main
  (block entry
    (leaq (deref-label (label x-println-non-void)) (var _₁))
    (leaq (deref-label (label x-random-dice)) (var _₂))
    (movq (var _₂) (reg rdi))
    (callq-n (label x-apply-nullary) (arity 1))
    (movq (reg rax) (var x₁))
    (leaq (deref-label (label x-random-dice)) (var _₃))
    (movq (var _₃) (reg rdi))
    (callq-n (label x-apply-nullary) (arity 1))
    (movq (reg rax) (var y₁))
    (leaq (deref-label (label x-int-less?)) (var _₆))
    (movq (var _₆) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (imm 1) (var _₈))
    (movq (var _₇) (reg rdi))
    (movq (var _₈) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (cmpq (var _₉) (imm 1))
    (branch-if (cc e) (label main/then₅) (label main/else₆)))
  (block main/let-body₁
    (movq (var _₁) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq))
  (block main/then₂
    (leaq (deref-label (label x-iadd)) (var _₁₆))
    (movq (var _₁₆) (reg rdi))
    (movq (var y₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₇))
    (movq (imm 2) (var _₁₈))
    (movq (var _₁₇) (reg rdi))
    (movq (var _₁₈) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (jmp (label main/let-body₁)))
  (block main/else₃
    (leaq (deref-label (label x-iadd)) (var _₁₉))
    (movq (var _₁₉) (reg rdi))
    (movq (var y₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₂₀))
    (movq (imm 10) (var _₂₁))
    (movq (var _₂₀) (reg rdi))
    (movq (var _₂₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (jmp (label main/let-body₁)))
  (block main/let-body₄
    (cmpq (var _₅) (imm 1))
    (branch-if (cc e) (label main/then₂) (label main/else₃)))
  (block main/then₅
    (leaq (deref-label (label x-equal?)) (var _₁₀))
    (movq (var _₁₀) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₁))
    (movq (imm 0) (var _₁₂))
    (movq (var _₁₁) (reg rdi))
    (movq (var _₁₂) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (jmp (label main/let-body₄)))
  (block main/else₆
    (leaq (deref-label (label x-equal?)) (var _₁₃))
    (movq (var _₁₃) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₄))
    (movq (imm 2) (var _₁₅))
    (movq (var _₁₄) (reg rdi))
    (movq (var _₁₅) (reg rsi))
    (callq-n (label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (jmp (label main/let-body₄))))

(extern
  x-identity
  x-same?
  x-equal?
  x-atom?
  x-anything?
  x-print
  x-println-non-void
  x-write
  x-newline
  x-bool?
  x-not
  x-int?
  x-int-positive?
  x-int-non-negative?
  x-int-non-zero?
  x-ineg
  x-iadd
  x-isub
  x-imul
  x-idiv
  x-imod
  x-int-max
  x-int-min
  x-int-greater?
  x-int-less?
  x-int-greater-equal?
  x-int-less-equal?
  x-int-compare-ascending
  x-int-compare-descending
  x-float?
  x-float-positive?
  x-float-non-negative?
  x-float-non-zero?
  x-fneg
  x-fadd
  x-fsub
  x-fmul
  x-fdiv
  x-float-max
  x-float-min
  x-float-greater?
  x-float-less?
  x-float-greater-equal?
  x-float-less-equal?
  x-float-compare-ascending
  x-float-compare-descending
  x-make-curry
  x-curry-put!
  x-random-dice
  x-random-int
  x-random-float)

