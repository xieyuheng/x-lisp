;;; Input

(define (main)
  (println-non-void
   (begin (= x (iadd 42 (ineg 10))) (iadd x 10))))

;;; ShrinkPass

(define (main)
  (println-non-void
   (@let1 x ((iadd 42) (ineg 10)) ((iadd x) 10))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 x₁ ((iadd 42) (ineg 10)) ((iadd x₁) 10))))

;;; RevealFunctionPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁
       (((@primitive-function iadd 2) 42)
        ((@primitive-function ineg 1) 10))
     (((@primitive-function iadd 2) x₁) 10))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁
       (((@primitive-function iadd 2) 42)
        ((@primitive-function ineg 1) 10))
     (((@primitive-function iadd 2) x₁) 10))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 x₁
        (@let1 _₂ (@primitive-function iadd 2)
          (@let1 _₃ 42
            (@let1 _₄ (_₂ _₃)
              (@let1 _₅ (@primitive-function ineg 1)
                (@let1 _₆ 10 (@let1 _₇ (_₅ _₆) (_₄ _₇)))))))
      (@let1 _₈ (@primitive-function iadd 2)
        (@let1 _₉ (_₈ x₁)
          (@let1 _₁₀ 10 (@let1 _₁₁ (_₉ _₁₀) (_₁ _₁₁))))))))

;;; ExplicateControlPass

(define-function main
  (block body
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const (@primitive-function iadd 2)))
    (= _₃ (const 42))
    (= _₄ (apply _₂ _₃))
    (= _₅ (const (@primitive-function ineg 1)))
    (= _₆ (const 10))
    (= _₇ (apply _₅ _₆))
    (= x₁ (apply _₄ _₇))
    (= _₈ (const (@primitive-function iadd 2)))
    (= _₉ (apply _₈ x₁))
    (= _₁₀ (const 10))
    (= _₁₁ (apply _₉ _₁₀))
    (= _↩ (apply _₁ _₁₁))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq (imm 336) (var _₃))
    (movq (var _₂) (reg rdi))
    (movq (var _₃) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₅))
    (movq (imm 80) (var _₆))
    (movq (var _₅) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (var _₄) (reg rdi))
    (movq (var _₇) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var x₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₈))
    (movq (var _₈) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (movq (imm 80) (var _₁₀))
    (movq (var _₉) (reg rdi))
    (movq (var _₁₀) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₁))
    (movq (var _₁) (reg rdi))
    (movq (var _₁₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 80) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (imm 80) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -136) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -152) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (movq (reg-deref (reg rbp) -160) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 80) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (imm 80) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -136) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -152) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (movq (reg-deref (reg rbp) -160) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 56) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 80) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (salq (imm 3) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (imm 80) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -136) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -152) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (movq (reg-deref (reg rbp) -160) (reg rax))
    (retq))
  (block epilog
    (addq (imm 56) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

