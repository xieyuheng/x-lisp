---
title: using vm
date: 2025-11-20
---

# why?

我决定用 VM 来实现 x-lisp，
因为对于动态类型语言而言，
GC 相关的问题太复杂了。

对于之后要实现的静态类型语言再实现编译器，比如 meta-lisp。

或者更合适地，是对于不需要 GC 的语言来实现编译器，
比如 system-lisp 和 linear-lisp。

# 行动

新的任务大概是：

- port x-sexp.js to runtime。

- port basic-lisp to runtime。

  - 保持现在的极简 instruction，
    对于 call 指令和某些 primitive function 做 inline 优化（比如 iadd），
    basic-lisp 的解释器要能写成一个简单的，
    有 switch 和很多 case 的 C 函数。

- 还是需要 GC，只不过这次 root scanning 问题简单多了。

但是可能不能直接实现 basic-lisp 的 vm。
因为对于底层 vm 或者 native 汇编来说，
call 和 assign 应该是两个指令。
而 basic-lisp 中 call 和 assign 到 dest 是一个指令。

也就是说：

- 要么在 c 的 byte code 解释器中拆分指令；
- 要么实现一个 basic-lisp 到 vm 的 instruction selection。

我想可能后者更合理一些。

可能要回到 xvm 和 xasm 以及 xrom 或 xexe 的设计。
