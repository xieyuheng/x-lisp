;;; Input

(define (main)
  (println-non-void
   (begin
     (= v 1)
     (= w 42)
     (= x (iadd v 7))
     (= y x)
     (= z (iadd x w))
     (iadd z (ineg y)))))

;;; ShrinkPass

(define (main)
  (println-non-void
   (@let1 v 1
     (@let1 w 42
       (@let1 x ((iadd v) 7)
         (@let1 y x
           (@let1 z ((iadd x) w) ((iadd z) (ineg y)))))))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 v₁ 1
     (@let1 w₁ 42
       (@let1 x₁ ((iadd v₁) 7)
         (@let1 y₁ x₁
           (@let1 z₁ ((iadd x₁) w₁) ((iadd z₁) (ineg y₁)))))))))

;;; RevealGlobalPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 v₁ 1
     (@let1 w₁ 42
       (@let1 x₁ (((@primitive-function iadd 2) v₁) 7)
         (@let1 y₁ x₁
           (@let1 z₁ (((@primitive-function iadd 2) x₁) w₁)
             (((@primitive-function iadd 2) z₁)
              ((@primitive-function ineg 1) y₁)))))))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 v₁ 1
     (@let1 w₁ 42
       (@let1 x₁ (((@primitive-function iadd 2) v₁) 7)
         (@let1 y₁ x₁
           (@let1 z₁ (((@primitive-function iadd 2) x₁) w₁)
             (((@primitive-function iadd 2) z₁)
              ((@primitive-function ineg 1) y₁)))))))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 v₁ (@let1 _₂ 1 _₂)
      (@let1 w₁ (@let1 _₃ 42 _₃)
        (@let1 x₁
            (@let1 _₄ (@primitive-function iadd 2)
              (@let1 _₅ (_₄ v₁) (@let1 _₆ 7 (_₅ _₆))))
          (@let1 y₁ x₁
            (@let1 z₁
                (@let1 _₇ (@primitive-function iadd 2)
                  (@let1 _₈ (_₇ x₁) (_₈ w₁)))
              (@let1 _₉ (@primitive-function iadd 2)
                (@let1 _₁₀ (_₉ z₁)
                  (@let1 _₁₁ (@primitive-function ineg 1)
                    (@let1 _₁₂ (_₁₁ y₁)
                      (@let1 _₁₃ (_₁₀ _₁₂) (_₁ _₁₃)))))))))))))

;;; ExplicateControlPass

(define-function main
  (block body
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const 1))
    (= v₁ (call (@primitive-function identity 1) _₂))
    (= _₃ (const 42))
    (= w₁ (call (@primitive-function identity 1) _₃))
    (= _₄ (const (@primitive-function iadd 2)))
    (= _₅ (apply _₄ v₁))
    (= _₆ (const 7))
    (= x₁ (apply _₅ _₆))
    (= y₁ (call (@primitive-function identity 1) x₁))
    (= _₇ (const (@primitive-function iadd 2)))
    (= _₈ (apply _₇ x₁))
    (= z₁ (apply _₈ w₁))
    (= _₉ (const (@primitive-function iadd 2)))
    (= _₁₀ (apply _₉ z₁))
    (= _₁₁ (const (@primitive-function ineg 1)))
    (= _₁₂ (apply _₁₁ y₁))
    (= _₁₃ (apply _₁₀ _₁₂))
    (= _↩ (apply _₁ _₁₃))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (imm 8) (var _₂))
    (movq (var _₂) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var v₁))
    (movq (imm 336) (var _₃))
    (movq (var _₃) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var w₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₄))
    (movq (var _₄) (reg rdi))
    (movq (var v₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (imm 56) (var _₆))
    (movq (var _₅) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var x₁))
    (movq (var x₁) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var y₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₇))
    (movq (var _₇) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₈))
    (movq (var _₈) (reg rdi))
    (movq (var w₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var z₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₉))
    (movq (var _₉) (reg rdi))
    (movq (var z₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₀))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁₁))
    (movq (var _₁₁) (reg rdi))
    (movq (var y₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₂))
    (movq (var _₁₀) (reg rdi))
    (movq (var _₁₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₁₃))
    (movq (var _₁) (reg rdi))
    (movq (var _₁₃) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 8) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 336) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (imm 56) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rdi))
    (movq (reg-deref (reg rbp) -128) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -168))
    (movq (reg-deref (reg rbp) -168) (reg rdi))
    (movq (reg-deref (reg rbp) -160) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -176))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -184))
    (movq (reg-deref (reg rbp) -184) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -192))
    (movq (reg-deref (reg rbp) -176) (reg rdi))
    (movq (reg-deref (reg rbp) -192) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -200))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -200) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -208))
    (movq (reg-deref (reg rbp) -208) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 8) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 336) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (imm 56) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rdi))
    (movq (reg-deref (reg rbp) -128) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -168))
    (movq (reg-deref (reg rbp) -168) (reg rdi))
    (movq (reg-deref (reg rbp) -160) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -176))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -184))
    (movq (reg-deref (reg rbp) -184) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -192))
    (movq (reg-deref (reg rbp) -176) (reg rdi))
    (movq (reg-deref (reg rbp) -192) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -200))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -200) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -208))
    (movq (reg-deref (reg rbp) -208) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 208) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 8) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 336) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (imm 56) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rdi))
    (movq (reg-deref (reg rbp) -128) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -160))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -168))
    (movq (reg-deref (reg rbp) -168) (reg rdi))
    (movq (reg-deref (reg rbp) -160) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -176))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -184))
    (movq (reg-deref (reg rbp) -184) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -192))
    (movq (reg-deref (reg rbp) -176) (reg rdi))
    (movq (reg-deref (reg rbp) -192) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -200))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -200) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -208))
    (movq (reg-deref (reg rbp) -208) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 208) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

