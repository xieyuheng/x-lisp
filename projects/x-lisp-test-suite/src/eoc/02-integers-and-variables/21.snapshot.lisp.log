;;; Input

(define (main)
  (println-non-void
   (begin
     (= y 6)
     (begin (= x (begin (= y (ineg 42)) y)) (iadd x y)))))

;;; ShrinkPass

(define (main)
  (println-non-void
   (@let1 y 6 (@let1 x (@let1 y (ineg 42) y) ((iadd x) y)))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 y₁ 6
     (@let1 x₁ (@let1 y₂ (ineg 42) y₂) ((iadd x₁) y₁)))))

;;; RevealGlobalPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 y₁ 6
     (@let1 x₁
         (@let1 y₂ ((@primitive-function ineg 1) 42) y₂)
       (((@primitive-function iadd 2) x₁) y₁)))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 y₁ 6
     (@let1 x₁
         (@let1 y₂ ((@primitive-function ineg 1) 42) y₂)
       (((@primitive-function iadd 2) x₁) y₁)))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 y₁ (@let1 _₂ 6 _₂)
      (@let1 x₁
          (@let1 y₂
              (@let1 _₃ (@primitive-function ineg 1)
                (@let1 _₄ 42 (_₃ _₄)))
            y₂)
        (@let1 _₅ (@primitive-function iadd 2)
          (@let1 _₆ (_₅ x₁) (@let1 _₇ (_₆ y₁) (_₁ _₇))))))))

;;; ExplicateControlPass

(define-function main
  (block body
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const 6))
    (= y₁ (call (@primitive-function identity 1) _₂))
    (= _₃ (const (@primitive-function ineg 1)))
    (= _₄ (const 42))
    (= y₂ (apply _₃ _₄))
    (= x₁ (call (@primitive-function identity 1) y₂))
    (= _₅ (const (@primitive-function iadd 2)))
    (= _₆ (apply _₅ x₁))
    (= _₇ (apply _₆ y₁))
    (= _↩ (apply _₁ _₇))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (imm 48) (var _₂))
    (movq (var _₂) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var y₁))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₃))
    (movq (imm 336) (var _₄))
    (movq (var _₃) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var y₂))
    (movq (var y₂) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var x₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₅))
    (movq (var _₅) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₆))
    (movq (var _₆) (reg rdi))
    (movq (var y₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (var _₁) (reg rdi))
    (movq (var _₇) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 48) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 336) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 48) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 336) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 144) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 48) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 336) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -144) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 144) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

