;;; Input

(define (_main)
  (println-non-void
   (begin (= x 32) (iadd (begin (= x 10) x) x))))

;;; ShrinkPass

(define (_main)
  (println-non-void (@let1 x 32 ((iadd (@let1 x 10 x)) x))))

;;; UniquifyPass

(define (_main)
  (println-non-void
   (@let1 x₁ 32 ((iadd (@let1 x₂ 10 x₂)) x₁))))

;;; RevealGlobalPass

(define (_main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ 32
     (((@primitive-function iadd 2) (@let1 x₂ 10 x₂)) x₁))))

;;; LiftLambdaPass

(define (_main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ 32
     (((@primitive-function iadd 2) (@let1 x₂ 10 x₂)) x₁))))

;;; UnnestOperandPass

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 x₁ 32
      (@let1 _₂ (@primitive-function iadd 2)
        (@let1 x₂ 10
          (@let1 _₃ (_₂ x₂) (@let1 _₄ (_₃ x₁) (_₁ _₄))))))))

;;; ExplicateControlPass

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= x₁ (literal 32))
    (= _₂ (literal (@primitive-function iadd 2)))
    (= x₂ (literal 10))
    (= _₃ (apply _₂ x₂))
    (= _₄ (apply _₃ x₁))
    (= _↩ (apply _₁ _₄))
    (return _↩)))

;;; SelectInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (imm 256) (var x₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq (imm 80) (var x₂))
    (movq (var _₂) (reg rdi))
    (movq (var x₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (movq (var _₁) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code _setup (block body))

;;; AssignHomePass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 80) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (retq)))

(define-code _setup (block body))

;;; PatchInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 80) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (retq)))

(define-code _setup (block body))

;;; PrologAndEpilogPass

(export _setup _main)

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 112) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 80) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 112) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 56) (reg rsp))
    (jmp (label body)))
  (block body)
  (block epilog
    (addq (imm 56) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

