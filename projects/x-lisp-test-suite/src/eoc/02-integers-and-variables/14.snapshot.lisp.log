;;; Input

(define (main)
  (println-non-void
   (begin (= x 32) (iadd (begin (= x 10) x) x))))

;;; ShrinkPass

(define (main)
  (println-non-void (@let1 x 32 ((iadd (@let1 x 10 x)) x))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 x₁ 32 ((iadd (@let1 x₂ 10 x₂)) x₁))))

;;; RevealGlobalPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ 32
     (((@primitive-function iadd 2) (@let1 x₂ 10 x₂)) x₁))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁ 32
     (((@primitive-function iadd 2) (@let1 x₂ 10 x₂)) x₁))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 x₁ (@let1 _₂ 32 _₂)
      (@let1 _₃ (@primitive-function iadd 2)
        (@let1 x₂ (@let1 _₄ 10 _₄)
          (@let1 _₅ (_₃ x₂) (@let1 _₆ (_₅ x₁) (_₁ _₆))))))))

;;; ExplicateControlPass

(define-function main
  (block body
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const 32))
    (= x₁ (call (@primitive-function identity 1) _₂))
    (= _₃ (const (@primitive-function iadd 2)))
    (= _₄ (const 10))
    (= x₂ (call (@primitive-function identity 1) _₄))
    (= _₅ (apply _₃ x₂))
    (= _₆ (apply _₅ x₁))
    (= _↩ (apply _₁ _₆))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (imm 256) (var _₂))
    (movq (var _₂) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var x₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₃))
    (movq (imm 80) (var _₄))
    (movq (var _₄) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var x₂))
    (movq (var _₃) (reg rdi))
    (movq (var x₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (var _₅) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₆))
    (movq (var _₁) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 80) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 80) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 128) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 256) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (imm 80) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 128) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

