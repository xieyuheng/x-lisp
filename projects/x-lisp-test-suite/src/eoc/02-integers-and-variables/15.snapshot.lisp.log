;;; Input

(define (main)
  (println-non-void
   (begin (= x (begin (= x 4) (iadd x 1))) (iadd x 2))))

;;; ShrinkPass

(define (main)
  (println-non-void
   (@let1 x (@let1 x 4 ((iadd x) 1)) ((iadd x) 2))))

;;; UniquifyPass

(define (main)
  (println-non-void
   (@let1 x₁ (@let1 x₂ 4 ((iadd x₂) 1)) ((iadd x₁) 2))))

;;; RevealGlobalPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁
       (@let1 x₂ 4 (((@primitive-function iadd 2) x₂) 1))
     (((@primitive-function iadd 2) x₁) 2))))

;;; LiftLambdaPass

(define (main)
  ((@primitive-function println-non-void 1)
   (@let1 x₁
       (@let1 x₂ 4 (((@primitive-function iadd 2) x₂) 1))
     (((@primitive-function iadd 2) x₁) 2))))

;;; UnnestOperandPass

(define (main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 x₁
        (@let1 x₂ (@let1 _₂ 4 _₂)
          (@let1 _₃ (@primitive-function iadd 2)
            (@let1 _₄ (_₃ x₂) (@let1 _₅ 1 (_₄ _₅)))))
      (@let1 _₆ (@primitive-function iadd 2)
        (@let1 _₇ (_₆ x₁)
          (@let1 _₈ 2 (@let1 _₉ (_₇ _₈) (_₁ _₉))))))))

;;; ExplicateControlPass

(define-function main
  (block body
    (= _₁ (const (@primitive-function println-non-void 1)))
    (= _₂ (const 4))
    (= x₂ (call (@primitive-function identity 1) _₂))
    (= _₃ (const (@primitive-function iadd 2)))
    (= _₄ (apply _₃ x₂))
    (= _₅ (const 1))
    (= x₁ (apply _₄ _₅))
    (= _₆ (const (@primitive-function iadd 2)))
    (= _₇ (apply _₆ x₁))
    (= _₈ (const 2))
    (= _₉ (apply _₇ _₈))
    (= _↩ (apply _₁ _₉))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (imm 32) (var _₂))
    (movq (var _₂) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (var x₂))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (movq (var x₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (movq (imm 8) (var _₅))
    (movq (var _₄) (reg rdi))
    (movq (var _₅) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var x₁))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₆))
    (movq (var _₆) (reg rdi))
    (movq (var x₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₇))
    (movq (imm 16) (var _₈))
    (movq (var _₇) (reg rdi))
    (movq (var _₈) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₉))
    (movq (var _₁) (reg rdi))
    (movq (var _₉) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 32) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 8) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (imm 16) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 32) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 8) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (imm 16) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 152) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (imm 32) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (callq-n (external-label x-identity) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (imm 8) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -96) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (leaq (label-deref (external-label x-iadd)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -120) (reg rdi))
    (movq (reg-deref (reg rbp) -112) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (imm 16) (reg-deref (reg rbp) -136))
    (movq (reg-deref (reg rbp) -128) (reg rdi))
    (movq (reg-deref (reg rbp) -136) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -144))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -144) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -152))
    (movq (reg-deref (reg rbp) -152) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 152) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

