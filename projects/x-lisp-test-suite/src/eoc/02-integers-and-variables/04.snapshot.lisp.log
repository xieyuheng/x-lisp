;;; Input

(define (_main)
  (println-non-void
   (begin
     (= z (begin (= y (begin (= x (ineg 42)) x)) y))
     (ineg z))))

;;; ShrinkPass

(define (_main)
  (println-non-void
   (@let1 z (@let1 y (@let1 x (ineg 42) x) y) (ineg z))))

;;; UniquifyPass

(define (_main)
  (println-non-void
   (@let1 z₁ (@let1 y₁ (@let1 x₁ (ineg 42) x₁) y₁)
     (ineg z₁))))

;;; RevealGlobalPass

(define (_main)
  ((@primitive-function println-non-void 1)
   (@let1 z₁
       (@let1 y₁
           (@let1 x₁ ((@primitive-function ineg 1) 42) x₁)
         y₁)
     ((@primitive-function ineg 1) z₁))))

;;; LiftLambdaPass

(define (_main)
  ((@primitive-function println-non-void 1)
   (@let1 z₁
       (@let1 y₁
           (@let1 x₁ ((@primitive-function ineg 1) 42) x₁)
         y₁)
     ((@primitive-function ineg 1) z₁))))

;;; UnnestOperandPass

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 z₁
        (@let1 y₁
            (@let1 x₁
                (@let1 _₂ (@primitive-function ineg 1)
                  (@let1 _₃ 42 (_₂ _₃)))
              x₁)
          y₁)
      (@let1 _₄ (@primitive-function ineg 1)
        (@let1 _₅ (_₄ z₁) (_₁ _₅))))))

;;; ExplicateControlPass

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= _₂ (literal (@primitive-function ineg 1)))
    (= _₃ (literal 42))
    (= x₁ (apply _₂ _₃))
    (= y₁ (identity x₁))
    (= z₁ (identity y₁))
    (= _₄ (literal (@primitive-function ineg 1)))
    (= _₅ (apply _₄ z₁))
    (= _↩ (apply _₁ _₅))
    (return _↩)))

(define-variable __main/constant)

(define-setup __main/setup
  (block body
    (= function-address (literal (@address _main)))
    (= arity (literal 0))
    (= size (literal 0))
    (= curry
       (call
        (@primitive-function make-curry 3)
        function-address
        arity
        size))
    (store __main/constant curry)
    (return)))

;;; SelectInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq (imm 336) (var _₃))
    (movq (var _₂) (reg rdi))
    (movq (var _₃) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var x₁))
    (movq (var x₁) (var y₁))
    (movq (var y₁) (var z₁))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₄))
    (movq (var _₄) (reg rdi))
    (movq (var z₁) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (var _₁) (reg rdi))
    (movq (var _₅) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-space __main/constant 8)

(define-code __main/setup
  (block body
    (movq (label-imm (label _main)) (var function-address))
    (orq (imm 3) (var function-address))
    (movq (imm 0) (var arity))
    (movq (imm 0) (var size))
    (movq (var function-address) (reg rdi))
    (movq (var arity) (reg rsi))
    (movq (var size) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var curry))
    (movq (var curry) (label-deref (label __main/constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label __main/setup) (arity 0))
    (movq (reg rax) (var _))))

;;; AssignHomePass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq
     (reg-deref (reg rbp) -88)
     (reg-deref (reg rbp) -96))
    (movq
     (reg-deref (reg rbp) -96)
     (reg-deref (reg rbp) -104))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (retq)))

(define-space __main/constant 8)

(define-code __main/setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq
     (reg-deref (reg rbp) -88)
     (label-deref (label __main/constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label __main/setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PatchInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (retq)))

(define-space __main/constant 8)

(define-code __main/setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label __main/constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label __main/setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PrologAndEpilogPass

(export _setup _main)

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 128) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 336) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -120))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -120) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -128))
    (movq (reg-deref (reg rbp) -128) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 128) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-space __main/constant 8)

(define-code __main/setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 88) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label __main/constant)))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 88) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 64) (reg rsp))
    (jmp (label body)))
  (block body
    (callq-n (label __main/setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64)))
  (block epilog
    (addq (imm 64) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

