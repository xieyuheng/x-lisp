;;; Input

(define (_main) (println-non-void (ineg (random-dice))))

;;; ShrinkPass

(define (_main) (println-non-void (ineg (random-dice))))

;;; UniquifyPass

(define (_main) (println-non-void (ineg (random-dice))))

;;; RevealGlobalPass

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@primitive-function ineg 1)
    ((@primitive-function random-dice 0)))))

;;; LiftLambdaPass

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@primitive-function ineg 1)
    ((@primitive-function random-dice 0)))))

;;; UnnestOperandPass

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 _₂ (@primitive-function ineg 1)
      (@let1 _₃ (@primitive-function random-dice 0)
        (@let1 _₄ (_₃) (@let1 _₅ (_₂ _₄) (_₁ _₅)))))))

;;; ExplicateControlPass

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= _₂ (literal (@primitive-function ineg 1)))
    (= _₃ (literal (@primitive-function random-dice 0)))
    (= _₄ (apply-nullary _₃))
    (= _₅ (apply _₂ _₄))
    (= _↩ (apply _₁ _₅))
    (return _↩)))

(define-variable _main©constant)

(define-setup _main©setup
  (block body
    (= function-address (literal (@address _main)))
    (= arity (literal 0))
    (= size (literal 0))
    (= curry
       (call
        (@primitive-function make-curry 3)
        function-address
        arity
        size))
    (store _main©constant curry)
    (return)))

;;; SelectInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq
     (label-imm (external-label x-random-dice))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 0) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₃))
    (movq (var _₃) (reg rdi))
    (callq-n (external-label x-apply-nullary) (arity 1))
    (movq (reg rax) (var _₄))
    (movq (var _₂) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (var _₁) (reg rdi))
    (movq (var _₅) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq (label-imm (label _main)) (var function-address))
    (orq (imm 3) (var function-address))
    (movq (imm 0) (var arity))
    (movq (imm 0) (var size))
    (movq (var function-address) (reg rdi))
    (movq (var arity) (reg rsi))
    (movq (var size) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var curry))
    (movq (var curry) (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (var _))))

;;; AssignHomePass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq
     (label-imm (external-label x-random-dice))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 0) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (callq-n (external-label x-apply-nullary) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq
     (reg-deref (reg rbp) -88)
     (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PatchInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq
     (label-imm (external-label x-random-dice))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 0) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (callq-n (external-label x-apply-nullary) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PrologAndEpilogPass

(export _setup _main)

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 104) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (external-label x-ineg)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq
     (label-imm (external-label x-random-dice))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 0) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (callq-n (external-label x-apply-nullary) (arity 1))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -104) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 104) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 88) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label _main©constant)))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 88) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 64) (reg rsp))
    (jmp (label body)))
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64)))
  (block epilog
    (addq (imm 64) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

