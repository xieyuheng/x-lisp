;;; Input

(define (_main) (println-non-void (if #t 1 2)))

;;; ShrinkPass

(define (_main) (println-non-void (if #t 1 2)))

;;; UniquifyPass

(define (_main) (println-non-void (if #t 1 2)))

;;; RevealGlobalPass

(define (_main)
  ((@primitive-function println-non-void 1) (if #t 1 2)))

;;; LiftLambdaPass

(define (_main)
  ((@primitive-function println-non-void 1) (if #t 1 2)))

;;; UnnestOperandPass

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 _₂ (@let1 _₃ #t (if _₃ 1 2)) (_₁ _₂))))

;;; ExplicateControlPass

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= _₃ (literal #t))
    (branch _₃ _main/then₂ _main/else₃))
  (block _main/let-body₁ (= _↩ (apply _₁ _₂)) (return _↩))
  (block _main/then₂
    (= _₂ (literal 1))
    (goto _main/let-body₁))
  (block _main/else₃
    (= _₂ (literal 2))
    (goto _main/let-body₁)))

;;; SelectInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (label-deref (external-label x-true)) (var _₃))
    (movq (label-deref (external-label x-true)) (reg rax))
    (cmpq (var _₃) (reg rax))
    (branch-if
     (cc e)
     (label _main/then₂)
     (label _main/else₃)))
  (block _main/let-body₁
    (movq (var _₁) (reg rdi))
    (movq (var _₂) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq))
  (block _main/then₂
    (movq (imm 8) (var _₂))
    (jmp (label _main/let-body₁)))
  (block _main/else₃
    (movq (imm 16) (var _₂))
    (jmp (label _main/let-body₁))))

(define-code _setup (block body))

;;; AssignHomePass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq
     (label-deref (external-label x-true))
     (reg-deref (reg rbp) -72))
    (movq (label-deref (external-label x-true)) (reg rax))
    (cmpq (reg-deref (reg rbp) -72) (reg rax))
    (branch-if
     (cc e)
     (label _main/then₂)
     (label _main/else₃)))
  (block _main/let-body₁
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (retq))
  (block _main/then₂
    (movq (imm 8) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁)))
  (block _main/else₃
    (movq (imm 16) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁))))

(define-code _setup (block body))

;;; PatchInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-deref (external-label x-true)) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (label-deref (external-label x-true)) (reg rax))
    (cmpq (reg-deref (reg rbp) -72) (reg rax))
    (branch-if
     (cc e)
     (label _main/then₂)
     (label _main/else₃)))
  (block _main/let-body₁
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (retq))
  (block _main/then₂
    (movq (imm 8) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁)))
  (block _main/else₃
    (movq (imm 16) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁))))

(define-code _setup (block body))

;;; PrologAndEpilogPass

(export _setup _main)

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 88) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-deref (external-label x-true)) (reg rax))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (label-deref (external-label x-true)) (reg rax))
    (cmpq (reg-deref (reg rbp) -72) (reg rax))
    (branch-if
     (cc e)
     (label _main/then₂)
     (label _main/else₃)))
  (block _main/let-body₁
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (jmp (label epilog)))
  (block _main/then₂
    (movq (imm 8) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁)))
  (block _main/else₃
    (movq (imm 16) (reg-deref (reg rbp) -80))
    (jmp (label _main/let-body₁)))
  (block epilog
    (addq (imm 88) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 56) (reg rsp))
    (jmp (label body)))
  (block body)
  (block epilog
    (addq (imm 56) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

