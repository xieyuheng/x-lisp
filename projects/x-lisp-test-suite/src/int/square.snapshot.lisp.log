;;; Input

(import "square" square)

(define (_main) (println-non-void (square (square 3))))

(define (square x) (imul x x))

;;; ShrinkPass

(import "square" square)

(define (_main) (println-non-void (square (square 3))))

(define (square x) (imul x x))

;;; UniquifyPass

(import "square" square)

(define (_main) (println-non-void (square (square 3))))

(define (square x) (imul x x))

;;; RevealGlobalPass

(import "square" square)

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@function square 1) ((@function square 1) 3))))

(define (square x) (imul x x))

;;; LiftLambdaPass

(import "square" square)

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@function square 1) ((@function square 1) 3))))

;;; UnnestOperandPass

(import "square" square)

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 _₂ (@function square 1)
      (@let1 _₃ (@function square 1)
        (@let1 _₄ 3
          (@let1 _₅ (_₃ _₄) (@let1 _₆ (_₂ _₅) (_₁ _₆))))))))

;;; ExplicateControlPass

(import "square" square)

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= _₂ (literal (@function square 1)))
    (= _₃ (literal (@function square 1)))
    (= _₄ (literal 3))
    (= _₅ (apply _₃ _₄))
    (= _₆ (apply _₂ _₅))
    (= _↩ (apply _₁ _₆))
    (return _↩)))

(define-variable _main©constant)

(define-setup _main©setup
  (block body
    (= function-address (literal (@address _main)))
    (= arity (literal 0))
    (= size (literal 0))
    (= curry
       (call
        (@primitive-function make-curry 3)
        function-address
        arity
        size))
    (store _main©constant curry)
    (return)))

;;; SelectInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₃))
    (movq (imm 24) (var _₄))
    (movq (var _₃) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₅))
    (movq (var _₂) (reg rdi))
    (movq (var _₅) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₆))
    (movq (var _₁) (reg rdi))
    (movq (var _₆) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq (label-imm (label _main)) (var function-address))
    (orq (imm 3) (var function-address))
    (movq (imm 0) (var arity))
    (movq (imm 0) (var size))
    (movq (var function-address) (reg rdi))
    (movq (var arity) (reg rsi))
    (movq (var size) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var curry))
    (movq (var curry) (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (var _))))

;;; AssignHomePass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 24) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq
     (reg-deref (reg rbp) -88)
     (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PatchInstructionPass

(export _setup _main)

(define-code _main
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 24) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label _main©constant)))
    (retq)))

(define-code _setup
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64))))

;;; PrologAndEpilogPass

(export _setup _main)

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 112) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (label-imm (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (imm 24) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -96) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -104))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -104) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -112))
    (movq (reg-deref (reg rbp) -112) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 112) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-space _main©constant 8)

(define-code _main©setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 88) (reg rsp))
    (jmp (label body)))
  (block body
    (movq
     (label-imm (label _main))
     (reg-deref (reg rbp) -64))
    (orq (imm 3) (reg-deref (reg rbp) -64))
    (movq (imm 0) (reg-deref (reg rbp) -72))
    (movq (imm 0) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -72) (reg rsi))
    (movq (reg-deref (reg rbp) -80) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (movq (reg rax) (label-deref (label _main©constant)))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 88) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _setup
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 64) (reg rsp))
    (jmp (label body)))
  (block body
    (callq-n (label _main©setup) (arity 0))
    (movq (reg rax) (reg-deref (reg rbp) -64)))
  (block epilog
    (addq (imm 64) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

