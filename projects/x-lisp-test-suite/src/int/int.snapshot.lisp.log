;;; Input

(define (square x) (imul x x))

(define (_main) (println-non-void (square 3)))

;;; ShrinkPass

(define (square x) ((imul x) x))

(define (_main) (println-non-void (square 3)))

;;; UniquifyPass

(define (square x) ((imul x) x))

(define (_main) (println-non-void (square 3)))

;;; RevealGlobalPass

(define (square x) (((@primitive-function imul 2) x) x))

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@function square 1) 3)))

;;; LiftLambdaPass

(define (square x) (((@primitive-function imul 2) x) x))

(define (_main)
  ((@primitive-function println-non-void 1)
   ((@function square 1) 3)))

;;; UnnestOperandPass

(define (square x)
  (@let1 _₁ (@primitive-function imul 2)
    (@let1 _₂ (_₁ x) (_₂ x))))

(define (_main)
  (@let1 _₁ (@primitive-function println-non-void 1)
    (@let1 _₂ (@function square 1)
      (@let1 _₃ 3 (@let1 _₄ (_₂ _₃) (_₁ _₄))))))

;;; ExplicateControlPass

(define-function square
  (block body
    (= x (argument 0))
    (= _₁ (literal (@primitive-function imul 2)))
    (= _₂ (apply _₁ x))
    (= _↩ (apply _₂ x))
    (return _↩)))

(define-function _main
  (block body
    (= _₁ (literal (@primitive-function println-non-void 1)))
    (= _₂ (literal (@function square 1)))
    (= _₃ (literal 3))
    (= _₄ (apply _₂ _₃))
    (= _↩ (apply _₁ _₄))
    (return _↩)))

;;; SelectInstructionPass

(export)

(define-code square
  (block body
    (movq (reg rdi) (var x))
    (leaq (label-deref (external-label x-imul)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (movq (var _₁) (reg rdi))
    (movq (var x) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₂))
    (movq (var _₂) (reg rdi))
    (movq (var x) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₁))
    (leaq (label-deref (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (var _₂))
    (movq (imm 24) (var _₃))
    (movq (var _₂) (reg rdi))
    (movq (var _₃) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _₄))
    (movq (var _₁) (reg rdi))
    (movq (var _₄) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (var _↩))
    (movq (var _↩) (reg rax))
    (retq)))

;;; AssignHomePass

(export)

(define-code square
  (block body
    (movq (reg rdi) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-imul)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (retq)))

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 24) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rax))
    (retq)))

;;; PatchInstructionPass

(export)

(define-code square
  (block body
    (movq (reg rdi) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-imul)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (retq)))

(define-code _main
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 24) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rax))
    (retq)))

;;; PrologAndEpilogPass

(export)

(define-code square
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 88) (reg rsp))
    (jmp (label body)))
  (block body
    (movq (reg rdi) (reg-deref (reg rbp) -64))
    (leaq (label-deref (external-label x-imul)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 16) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -80) (reg rdi))
    (movq (reg-deref (reg rbp) -64) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -88) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 88) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

(define-code _main
  (block prolog
    (pushq (reg rbp))
    (movq (reg rsp) (reg rbp))
    (pushq (reg rsp))
    (pushq (reg rbp))
    (pushq (reg rbx))
    (pushq (reg r12))
    (pushq (reg r13))
    (pushq (reg r14))
    (pushq (reg r15))
    (subq (imm 96) (reg rsp))
    (jmp (label body)))
  (block body
    (leaq
     (label-deref (external-label x-println-non-void))
     (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -64))
    (leaq (label-deref (label square)) (reg rdi))
    (orq (imm 3) (reg rdi))
    (movq (imm 8) (reg rsi))
    (movq (imm 0) (reg rdx))
    (callq-n (external-label x-make-curry) (arity 3))
    (movq (reg rax) (reg-deref (reg rbp) -72))
    (movq (imm 24) (reg-deref (reg rbp) -80))
    (movq (reg-deref (reg rbp) -72) (reg rdi))
    (movq (reg-deref (reg rbp) -80) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -88))
    (movq (reg-deref (reg rbp) -64) (reg rdi))
    (movq (reg-deref (reg rbp) -88) (reg rsi))
    (callq-n (external-label x-apply-unary) (arity 2))
    (movq (reg rax) (reg-deref (reg rbp) -96))
    (movq (reg-deref (reg rbp) -96) (reg rax))
    (jmp (label epilog)))
  (block epilog
    (addq (imm 96) (reg rsp))
    (popq (reg r15))
    (popq (reg r14))
    (popq (reg r13))
    (popq (reg r12))
    (popq (reg rbx))
    (popq (reg rbp))
    (popq (reg rsp))
    (popq (reg rbp))
    (retq)))

