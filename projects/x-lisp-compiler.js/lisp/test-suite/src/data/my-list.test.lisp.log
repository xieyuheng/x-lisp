;;; Input

(import-all "my-list")

(define (main)
  (assert-equal nil #nil)
  (assert-equal
    (li 1 (li 2 (li 3 nil)))
    [#li 1 [#li 2 [#li 3 #nil]]])
  (assert-equal (li-tail (li 1 nil)) nil)
  (assert-equal (li-head (li 1 nil)) 1)
  (= list (li 1 (li 2 (li 3 nil))))
  (assert-equal (li-head list) 1)
  (li-put-head! 111 list)
  (assert-equal (li-head list) 111)
  (assert-equal (li-tail list) (li 2 (li 3 nil)))
  (li-put-tail! nil list)
  (assert-equal (li-tail list) nil)
  (assert-equal (li 1 nil) ((li 1) nil)))

;;; Loaded

(define (main)
  (assert-equal nil #nil)
  (assert-equal
    (li 1 (li 2 (li 3 nil)))
    [#li 1 [#li 2 [#li 3 #nil]]])
  (assert-equal (li-tail (li 1 nil)) nil)
  (assert-equal (li-head (li 1 nil)) 1)
  (= list (li 1 (li 2 (li 3 nil))))
  (assert-equal (li-head list) 1)
  (li-put-head! 111 list)
  (assert-equal (li-head list) 111)
  (assert-equal (li-tail list) (li 2 (li 3 nil)))
  (li-put-tail! nil list)
  (assert-equal (li-tail list) nil)
  (assert-equal (li 1 nil) ((li 1) nil)))

(define-datatype TODO)

(define nil #nil)

(define (li head tail) [#li head tail])

(define (li-head target) (list-get 1 target))

(define (li-tail target) (list-get 2 target))

(define (li-put-head value target)
  (list-put 1 value target))

(define (li-put-tail value target)
  (list-put 2 value target))

(define (li-put-head! value target)
  (list-put! 1 value target))

(define (li-put-tail! value target)
  (list-put! 2 value target))

;;; ShrinkPass

(define (main)
  (assert-equal nil #nil)
  (assert-equal
    (li 1 (li 2 (li 3 nil)))
    (begin
      (= tael (make-list))
      (list-push! #li tael)
      (list-push! 1 tael)
      (list-push!
       (begin
         (= tael (make-list))
         (list-push! #li tael)
         (list-push! 2 tael)
         (list-push!
          (begin
            (= tael (make-list))
            (list-push! #li tael)
            (list-push! 3 tael)
            (list-push! #nil tael)
            tael)
          tael)
         tael)
       tael)
      tael))
  (assert-equal (li-tail (li 1 nil)) nil)
  (assert-equal (li-head (li 1 nil)) 1)
  (= list (li 1 (li 2 (li 3 nil))))
  (assert-equal (li-head list) 1)
  (li-put-head! 111 list)
  (assert-equal (li-head list) 111)
  (assert-equal (li-tail list) (li 2 (li 3 nil)))
  (li-put-tail! nil list)
  (assert-equal (li-tail list) nil)
  (assert-equal (li 1 nil) ((li 1) nil)))

(define-datatype TODO)

(define nil #nil)

(define (li head tail) [#li head tail])

(define (li-head target) (list-get 1 target))

(define (li-tail target) (list-get 2 target))

(define (li-put-head value target)
  (list-put 1 value target))

(define (li-put-tail value target)
  (list-put 2 value target))

(define (li-put-head! value target)
  (list-put! 1 value target))

(define (li-put-tail! value target)
  (list-put! 2 value target))

;;; UniquifyPass

(define (main)
  (assert-equal nil #nil)
  (assert-equal
    (li 1 (li 2 (li 3 nil)))
    (begin
      (= tael₁ (make-list))
      (list-push! #li tael₁)
      (list-push! 1 tael₁)
      (list-push!
       (begin
         (= tael₂ (make-list))
         (list-push! #li tael₂)
         (list-push! 2 tael₂)
         (list-push!
          (begin
            (= tael₃ (make-list))
            (list-push! #li tael₃)
            (list-push! 3 tael₃)
            (list-push! #nil tael₃)
            tael₃)
          tael₂)
         tael₂)
       tael₁)
      tael₁))
  (assert-equal (li-tail (li 1 nil)) nil)
  (assert-equal (li-head (li 1 nil)) 1)
  (= list₁ (li 1 (li 2 (li 3 nil))))
  (assert-equal (li-head list₁) 1)
  (li-put-head! 111 list₁)
  (assert-equal (li-head list₁) 111)
  (assert-equal (li-tail list₁) (li 2 (li 3 nil)))
  (li-put-tail! nil list₁)
  (assert-equal (li-tail list₁) nil)
  (assert-equal (li 1 nil) ((li 1) nil)))

(define-datatype TODO)

(define nil #nil)

(define (li head tail) [#li head tail])

(define (li-head target) (list-get 1 target))

(define (li-tail target) (list-get 2 target))

(define (li-put-head value target)
  (list-put 1 value target))

(define (li-put-tail value target)
  (list-put 2 value target))

(define (li-put-head! value target)
  (list-put! 1 value target))

(define (li-put-tail! value target)
  (list-put! 2 value target))

;;; LiftLambdaPass

(define (main)
  (assert-equal nil #nil)
  (assert-equal
    (li 1 (li 2 (li 3 nil)))
    (begin
      (= tael₁ (make-list))
      (list-push! #li tael₁)
      (list-push! 1 tael₁)
      (list-push!
       (begin
         (= tael₂ (make-list))
         (list-push! #li tael₂)
         (list-push! 2 tael₂)
         (list-push!
          (begin
            (= tael₃ (make-list))
            (list-push! #li tael₃)
            (list-push! 3 tael₃)
            (list-push! #nil tael₃)
            tael₃)
          tael₂)
         tael₂)
       tael₁)
      tael₁))
  (assert-equal (li-tail (li 1 nil)) nil)
  (assert-equal (li-head (li 1 nil)) 1)
  (= list₁ (li 1 (li 2 (li 3 nil))))
  (assert-equal (li-head list₁) 1)
  (li-put-head! 111 list₁)
  (assert-equal (li-head list₁) 111)
  (assert-equal (li-tail list₁) (li 2 (li 3 nil)))
  (li-put-tail! nil list₁)
  (assert-equal (li-tail list₁) nil)
  (assert-equal (li 1 nil) ((li 1) nil)))

;;; UnnestOperandPass

(define (main)
  (assert-equal nil #nil)
  (begin
    (= _₁ (li 3 nil))
    (= _₂ (li 2 _₁))
    (= _₃ (li 1 _₂))
    (= tael₁ (make-list))
    (list-push! #li tael₁)
    (list-push! 1 tael₁)
    (begin
      (= tael₂ (make-list))
      (list-push! #li tael₂)
      (list-push! 2 tael₂)
      (begin
        (= tael₃ (make-list))
        (list-push! #li tael₃)
        (list-push! 3 tael₃)
        (list-push! #nil tael₃)
        (list-push! tael₃ tael₂))
      (list-push! tael₂ tael₁))
    (assert-equal _₃ tael₁))
  (begin
    (= _₄ (li 1 nil))
    (= _₅ (li-tail _₄))
    (assert-equal _₅ nil))
  (begin
    (= _₆ (li 1 nil))
    (= _₇ (li-head _₆))
    (assert-equal _₇ 1))
  (= list₁
     (begin (= _₈ (li 3 nil)) (= _₉ (li 2 _₈)) (li 1 _₉)))
  (begin (= _₁₀ (li-head list₁)) (assert-equal _₁₀ 1))
  (li-put-head! 111 list₁)
  (begin (= _₁₁ (li-head list₁)) (assert-equal _₁₁ 111))
  (begin
    (= _₁₂ (li-tail list₁))
    (= _₁₃ (li 3 nil))
    (= _₁₄ (li 2 _₁₃))
    (assert-equal _₁₂ _₁₄))
  (li-put-tail! nil list₁)
  (begin (= _₁₅ (li-tail list₁)) (assert-equal _₁₅ nil))
  (= _₁₆ (li 1 nil))
  (= _₁₇ (li 1))
  (= _₁₈ (_₁₇ nil))
  (assert-equal _₁₆ _₁₈))

